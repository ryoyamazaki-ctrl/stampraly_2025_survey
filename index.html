<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>としまえんあたりのスタンプラリーご参加後アンケート</title>
<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --text:#222; --muted:#6b7280;
    --brand:#2563eb; --line:#e5e7eb; --alert:#eef5ff; --alert-line:#cfe0ff;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN",Meiryo,Roboto,Segoe UI,sans-serif;line-height:1.7}
  .container{max-width:980px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:22px}
  h1{margin:0 0 14px;font-size:clamp(20px,3.2vw,28px)}
  h2{margin:18px 0 10px;font-size:18px}
  fieldset{border:none;margin:0 0 16px;padding:0}
  .required::after{content:" *";color:#b00020}
  .help{font-size:12px;color:var(--muted)}
  .alert{background:var(--alert);border:1px solid var(--alert-line);border-radius:10px;padding:12px;margin:12px 0}
  .error{color:#b00020;margin-top:10px}
  .footer{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{appearance:none;border:0;border-radius:9px;background:var(--brand);color:#fff;padding:10px 16px;font-weight:700;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .btn-secondary{background:#6b7280}
  /* 視認性の高い選択肢UI */
  .grid{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .pill{display:flex;align-items:center;gap:.5em;border:1px solid var(--line);border-radius:10px;background:#fafafa;padding:8px 10px;cursor:pointer;transition:background .15s,border-color .15s}
  .pill:hover{background:#f5f7ff;border-color:#d8ddff}
  .pill input{transform:scale(1.1)}
  .box{border:1px solid var(--line);border-radius:10px;background:#fcfcfd;padding:10px;max-height:340px;overflow:auto}
  .muted{opacity:.5}
  .hide{display:none!important}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>としまえんあたりのスタンプラリーご参加後アンケート</h1>

    <!-- 入力画面 -->
    <div id="formView">
      <form id="surveyForm" novalidate>
        <!-- Q1 -->
        <fieldset>
          <h2 class="required">Q1：性別</h2>
          <div class="grid">
            <label class="pill"><input type="radio" name="q1_gender" value="男性" required>男性</label>
            <label class="pill"><input type="radio" name="q1_gender" value="女性">女性</label>
            <label class="pill"><input type="radio" name="q1_gender" value="その他">その他</label>
            <label class="pill"><input type="radio" name="q1_gender" value="不明">不明</label>
          </div>
        </fieldset>

        <!-- Q2 -->
        <fieldset>
          <h2 class="required">Q2：年代</h2>
          <div class="grid">
            <label class="pill"><input type="radio" name="q2_age" value="10代以下" required>10代以下</label>
            <label class="pill"><input type="radio" name="q2_age" value="20代">20代</label>
            <label class="pill"><input type="radio" name="q2_age" value="30代">30代</label>
            <label class="pill"><input type="radio" name="q2_age" value="40代">40代</label>
            <label class="pill"><input type="radio" name="q2_age" value="50代">50代</label>
            <label class="pill"><input type="radio" name="q2_age" value="60代">60代</label>
            <label class="pill"><input type="radio" name="q2_age" value="70代以上">70代以上</label>
          </div>
        </fieldset>

        <!-- Q3 郵便番号 -->
        <fieldset>
          <h2 class="required">Q3：お住まいの郵便番号</h2>
          <input id="zip" name="q3_zip" inputmode="numeric" pattern="\\d{7}" maxlength="7" minlength="7" required placeholder="例）1760001">
          <div class="help">半角数字7桁。7桁に達したらそれ以上は入力できません。</div>
        </fieldset>

        <!-- Q4 -->
        <fieldset>
          <h2 class="required">Q4：お住まいの居住年数</h2>
          <div class="grid">
            <label class="pill"><input type="radio" name="q4_years" value="1年未満" required>1年未満</label>
            <label class="pill"><input type="radio" name="q4_years" value="1年~3年未満">1年~3年未満</label>
            <label class="pill"><input type="radio" name="q4_years" value="3年~5年未満">3年~5年未満</label>
            <label class="pill"><input type="radio" name="q4_years" value="5年~10年未満">5年~10年未満</label>
            <label class="pill"><input type="radio" name="q4_years" value="10年~20年未満">10年~20年未満</label>
            <label class="pill"><input type="radio" name="q4_years" value="20年~30年未満">20年~30年未満</label>
            <label class="pill"><input type="radio" name="q4_years" value="30年以上">30年以上</label>
          </div>
        </fieldset>

        <!-- Q5 周知経路（単一選択：店舗・施設一覧 + その他） -->
        <fieldset>
          <h2 class="required">Q5：本スタンプラリー施策をどちらで知りましたか？</h2>
          <div id="q5_group" class="grid"></div>
          <input type="hidden" id="q5_source" name="q5_source" required>
          <div class="help">ひとつ選んでください。</div>
        </fieldset>

        <!-- Q6（複数／「なかった」排他） -->
        <fieldset>
          <h2 class="required">Q6：本スタンプラリー施策を機にはじめて行った店舗はありましたか？</h2>
          <div id="q6_group" class="box grid"></div>
          <div class="help">「なかった」を選ぶと他は自動で無効になります。</div>
        </fieldset>

        <!-- Q7（複数／「なかった」排他） -->
        <fieldset>
          <h2 class="required">Q7：本スタンプラリー施策を機に今後通いたい店舗はありましたか？</h2>
          <div id="q7_group" class="box grid"></div>
          <div class="help">「なかった」を選ぶと他は自動で無効になります。</div>
        </fieldset>

        <!-- Q8 任意 -->
        <fieldset>
          <h2>Q8：今後行われたら参加したい地域施策・イベントがあれば教えて下さい（任意）</h2>
          <textarea name="q8_free" rows="5" placeholder="自由記述"></textarea>
        </fieldset>

        <div id="err" class="error"></div>

        <div class="footer">
          <button id="submitBtn" type="submit">送信する</button>
          <button type="button" class="btn-secondary" onclick="location.reload()">入力をやり直す</button>
        </div>
      </form>
      <div class="alert">※ 送信後、完了画面に回答番号が表示されます。</div>
    </div>

    <!-- 完了画面 -->
    <div id="thanksView" class="hide">
      <h2>ご回答ありがとうございました！</h2>
      <div class="alert">あなたは <b id="respNum">—</b> 番目の回答者です。</div>
      <div class="footer"><button type="button" onclick="closeWindow()">ページを閉じる</button></div>
    </div>
  </div>
</div>

<script>
// ★ここを「googleusercontent の最終URL」に置換（例： https://script.googleusercontent.com/macros/echo?user_content_key=...&lib=... ）
const ENDPOINT = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi42Hv_W0pYRTwYBk52LlDrHiptRMN9aaXSVzKTJjMwwE7zt7dWcqlMXWgOSUKNkpbJIjNaN0i-9p43vLZBOsmUL9--P6y8E80H1Ap-519XFTJ3M5lfvlaJwyNUYFKG1PeFgomMs7deW_u-1GyWH5pM8A9v-NW7180SSLPVIoSzy_LfMxcY8FUVIORjZbg-MAtmB97_-UCIDSeAKY0Z33-J1T8k16wHZqCVkJcYNX0sp-aguevERnZ-6Lm8i0SAYZSHgqncLtXP238kmHuWQq1gzvHdfT7L5ReYCjbkZhih-9ciVeE&lib=MyZphAQ8ILK4SXivHuEv2PojldFBKTi0l';

/** 店舗リスト
 *  Q5 … ご指定の全店舗 + 「その他店舗・施設」
 *  Q6/Q7 … ご指定の全店舗（※「その他店舗・施設」は含めない）+ 「なかった」
 */
const SHOPS_BASE = [
  'gak','瀬戸田レモンと肉巻き野菜串 NERIMARU','木の実植物店','食堂まほろ','シリウスラボ',
  'セブンイレブン春日町5丁目店','コンビニエンスストア髙橋','わだぱん','佃宝 本店','志村電機珈琲焙煎所',
  '手打ちそばと酒肴 いちだい','練馬城址公園','Bis','トシママンガスタンド','スタジオツアー東京',
  'SNIP*SNIP','titi cafe','豊島園 庭の湯','バールウギャッデ','としまえん 多喜',
  '日本酒処 はち屋','笑天やきとり 一輝','練馬区立 向山庭園','タッポスト チャオラ','夢民家',
  '兄弟チキン','亀寿司','BBQ Records','カーサ・デル・ヴィアッジアトーレ','豊島園の夕陽',
  '111','THE GIANT STEP','アーバンオアシス タナカ','デュアン漢方薬局','かすたねっと',
  '口水食堂','猫カフェ えこねこ','metro dinner.'
];
const SHOPS_Q5 = [...SHOPS_BASE, 'その他店舗・施設'];     // 単一
const SHOPS_Q6Q7 = [...SHOPS_BASE, 'なかった'];           // 複数（※「その他」は入れない）

function makeId(prefix, name){
  return prefix + '_' + btoa(unescape(encodeURIComponent(name))).replace(/=+$/,'');
}

// Q5（単一） → hiddenへ反映
(function renderQ5(){
  const wrap=document.getElementById('q5_group');
  SHOPS_Q5.forEach(name=>{
    const id=makeId('q5',name);
    const ip=document.createElement('input'); ip.type='radio'; ip.name='q5_source_r'; ip.value=name; ip.id=id; ip.required=true;
    ip.addEventListener('change',()=>document.getElementById('q5_source').value=name);
    const lbl=document.createElement('label'); lbl.className='pill'; lbl.setAttribute('for',id);
    lbl.append(ip, document.createTextNode(' '+name));
    wrap.append(lbl);
  });
})();

// Q6/Q7（複数 + 「なかった」排他）
function renderCheckGroup(groupId){
  const wrap=document.getElementById(groupId);
  SHOPS_Q6Q7.forEach(name=>{
    const id=makeId(groupId,name);
    const ip=document.createElement('input'); ip.type='checkbox'; ip.value=name; ip.id=id;
    if(name==='なかった') ip.dataset.none='1';
    const lbl=document.createElement('label'); lbl.className='pill'; lbl.setAttribute('for',id);
    lbl.append(ip, document.createTextNode(' '+name));
    wrap.append(lbl);
  });
  // 排他 & 視覚グレーアウト
  wrap.addEventListener('change',()=>{
    const checks=[...wrap.querySelectorAll('input[type=checkbox]')];
    const none=checks.find(c=>c.dataset.none==='1');
    const items=checks.filter(c=>c.dataset.none!=='1');
    if(none && none.checked){
      items.forEach(c=>{ c.checked=false; c.disabled=true; c.parentElement.classList.add('muted'); });
    }else{
      items.forEach(c=>{ c.disabled=false; c.parentElement.classList.remove('muted'); });
    }
  });
}
renderCheckGroup('q6_group');
renderCheckGroup('q7_group');

// 郵便番号：7桁で自動打ち止め
document.getElementById('zip').addEventListener('input',e=>{
  e.target.value = e.target.value.replace(/\D/g,'').slice(0,7);
});

// === 送信：画面遷移（CORS完全回避） ===
document.getElementById('surveyForm').addEventListener('submit', (ev)=>{
  ev.preventDefault(); setError('');

  const f = new FormData(ev.target);
  const src = document.getElementById('q5_source').value;
  if(!src) return setError('Q5 を選択してください');

  const q6 = collectMulti('q6_group');
  const q7 = collectMulti('q7_group');
  if(q6.length===0) return setError('Q6 を選択してください');
  if(q7.length===0) return setError('Q7 を選択してください');
  if(!/^\d{7}$/.test(String(f.get('q3_zip')||''))) return setError('郵便番号は半角7桁で入力してください');

  const params = new URLSearchParams();
  params.set('action','submit');
  params.set('q1_gender', String(f.get('q1_gender')||''));
  params.set('q2_age',    String(f.get('q2_age')||''));
  params.set('q3_zip',    String(f.get('q3_zip')||''));
  params.set('q4_years',  String(f.get('q4_years')||''));
  params.set('q5_source', src);
  params.set('q6_firstStores', q6.join('|'));
  params.set('q7_futureStores', q7.join('|'));
  params.set('q8_free',  String(f.get('q8_free')||''));

  // ★ ここがポイント：サーバに「戻り先URL」を渡し、サーバ側で?n=xx を付けてリダイレクト
  params.set('redirect', encodeURIComponent(location.origin + location.pathname));

  const url = ENDPOINT + (ENDPOINT.includes('?')?'&':'?') + params.toString();
  // 画面遷移で送信（CORS無関係）
  location.href = url;
});

function collectMulti(groupId){
  const wrap=document.getElementById(groupId);
  const checks=[...wrap.querySelectorAll('input[type=checkbox]')];
  const none=checks.find(c=>c.dataset.none==='1');
  if(none && none.checked) return ['なかった'];
  return checks.filter(c=>c.checked && c.dataset.none!=='1').map(c=>c.value);
}

function setError(msg){ document.getElementById('err').textContent = msg || ''; }

// ページ再読込（リダイレクト後）：?n=xx があれば完了画面を表示
(function onLoadThanks(){
  const n = new URL(location.href).searchParams.get('n');
  if(n && /^\d+$/.test(n)){
    document.getElementById('respNum').textContent = n;
    document.getElementById('formView').classList.add('hide');
    document.getElementById('thanksView').classList.remove('hide');
  }
})();

function closeWindow(){
  try{ window.close(); }catch(_){}
  if(history.length>1) history.back(); else location.replace('about:blank');
}
</script>
</body>
</html>
